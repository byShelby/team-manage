# GPT Team 管理和兑换码自动邀请系统 - 核心需求

## 1. 项目概述

本项目旨在构建一个 ChatGPT Team 账号管理系统，支持管理员批量管理 Team 账号，用户通过兑换码自动加入 Team。

### 1.1 核心价值
- 自动化 Team 邀请流程
- 兑换码机制控制访问权限
- 可视化管理 Team 成员和配额

### 1.2 技术栈
- **后端**: Python + FastAPI
- **模板引擎**: Jinja2（服务器端渲染）
- **前端**: HTML + CSS + 原生 JavaScript（或 Alpine.js/HTMX）
- **数据存储**: SQLite（Team 信息、兑换码和使用记录）
- **HTTP 客户端**: curl_cffi（模拟浏览器指纹，绕过 Cloudflare 防护，支持代理）

---

## 2. 核心功能需求

### 2.1 管理员面板

#### 2.1.1 Team 账号管理
- **导入方式**
  - 单个导入：AT（必填）、邮箱（可选）、account-id（可选）
  - 批量导入：上传/粘贴文本内容，支持任意格式

- **智能格式识别**（批量导入）
  - 使用正则表达式自动识别和提取：AT Token、邮箱、Account ID
  - 支持任意分隔符：空格、逗号、制表符、换行等

- **多 Team 处理**
  - 如果一个 AT 关联多个 Team account-id，导入时默认使用第一个
  - 用户可通过编辑功能切换到其他 Team

- **Team 列表展示**
  - 显示邮箱、Team 名称、account-id、当前成员数/最大成员数（6人）
  - 订阅信息：到期时间、订阅计划类型
  - 状态标识：可用/已满/已过期/异常
  - 操作：查看成员、编辑、删除、刷新成员数

#### 2.1.2 成员管理
- **查看成员列表**：显示成员邮箱、名称、角色、加入时间
- **添加成员**：输入邮箱地址，调用邀请 API
- **删除成员**：确认对话框，调用删除 API（owner 不可删除）

#### 2.1.3 兑换码管理
- **生成兑换码**
  - 批量生成：指定数量、有效期
  - 单个生成：自定义兑换码、有效期
  - 说明：兑换码不绑定特定 Team，用户使用时可自由选择

- **兑换码列表**
  - 显示：兑换码、状态（未使用/已使用/已过期）、使用者邮箱、使用的 Team、使用时间
  - 操作：删除、导出

#### 2.1.4 使用记录
- 查看所有兑换记录（邮箱、兑换码、加入的 Team、时间）
- 筛选和搜索功能

#### 2.1.5 系统设置
- **代理配置**
  - HTTP 代理地址
  - HTTPS 代理地址
  - 启用/禁用代理

- **安全配置**
  - 管理员密码修改

- **系统配置**
  - 日志级别（DEBUG/INFO/WARNING/ERROR）

- **数据存储**
  - 配置信息存储在 SQLite 数据库的 `settings` 表中

### 2.2 用户页面

#### 2.2.1 加入 Team
- **输入表单**
  - 邮箱地址（必填，用户自己的邮箱）
  - 兑换码（必填）
  - 提交按钮

- **处理流程**
  1. 验证兑换码有效性（未使用、未过期）
  2. 展示可用的 Team 列表（成员数 < 6）
  3. 用户选择 Team 或系统随机分配
  4. 使用选中 Team 的 AT 调用 ChatGPT API，将用户邮箱添加到 Team
  5. 记录兑换使用情况（用户邮箱、兑换码、选择的 Team）
  6. 返回结果（成功/失败原因）

#### 2.2.2 Team 信息展示
- **可用 Team 列表**
  - 显示 Team 名称（不显示管理员邮箱）
  - 订阅到期时间
  - 当前人数/最大人数（x/6）
  - 状态指示器（绿色：可用，黄色：即将过期，红色：已满/已过期）

说明：用户无法查看 Team 成员列表，仅管理员可查看

---

## 3. 数据模型

### 3.1 兑换码表（SQLite）
```sql
CREATE TABLE redemption_codes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  code VARCHAR(32) UNIQUE NOT NULL,
  status VARCHAR(20) DEFAULT 'unused',  -- unused/used/expired
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP,
  used_by_email VARCHAR(255),
  used_team_id INTEGER,
  used_at TIMESTAMP,
  INDEX idx_code_status (code, status),
  FOREIGN KEY (used_team_id) REFERENCES teams(id)
);
```

### 3.2 Team 信息表（SQLite）
```sql
CREATE TABLE teams (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email VARCHAR(255) NOT NULL,
  access_token_encrypted TEXT NOT NULL,  -- 加密存储的 AT
  encryption_key_id VARCHAR(50),
  account_id VARCHAR(100),
  team_name VARCHAR(255),
  plan_type VARCHAR(50),
  subscription_plan VARCHAR(100),
  expires_at TIMESTAMP,
  current_members INTEGER DEFAULT 0,
  max_members INTEGER DEFAULT 6,
  status VARCHAR(20) DEFAULT 'active',
  last_sync TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_status (status)
);

-- Team Account 关联表
CREATE TABLE team_accounts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  team_id INTEGER NOT NULL,
  account_id VARCHAR(100) NOT NULL,
  account_name VARCHAR(255),
  is_primary BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE CASCADE,
  UNIQUE(team_id, account_id)
);
```

### 3.3 使用记录表（SQLite）
```sql
CREATE TABLE redemption_records (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email VARCHAR(255) NOT NULL,
  code VARCHAR(32) NOT NULL,
  team_id INTEGER NOT NULL,
  account_id VARCHAR(100) NOT NULL,
  redeemed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (team_id) REFERENCES teams(id),
  FOREIGN KEY (code) REFERENCES redemption_codes(code),
  INDEX idx_email (email)
);
```

### 3.4 系统设置表（SQLite）
```sql
CREATE TABLE settings (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  key VARCHAR(100) UNIQUE NOT NULL,
  value TEXT,
  description VARCHAR(255),
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**说明**：
- `key`: 配置项名称（如 `http_proxy`, `https_proxy`, `log_level`, `admin_password_hash`）
- `value`: 配置项值
- `description`: 配置项描述

---

## 4. 核心业务流程

### 4.1 管理员导入 Team 流程
1. 管理员上传/粘贴文本内容或单个输入
2. 系统使用正则表达式解析数据（AT、邮箱、account-id）
3. 验证和解析 AT（JWT）：验证签名、检查过期、提取 email
4. 获取 account-id 和订阅信息（如果未提供）
5. 加密存储 AT（信封加密）
6. 存储到数据库
7. 同步成员数量

### 4.2 用户兑换流程
```
用户输入邮箱 + 兑换码
    ↓
验证兑换码（存在、未使用、未过期）
    ↓
【开启数据库事务】
    ↓
展示可用 Team 列表（成员数 < 6）
    ↓
用户选择 Team 或随机分配
    ↓
【锁定选中的 Team 行（FOR UPDATE）】
    ↓
再次检查 Team 容量（防止并发冲突）
    ↓
调用 ChatGPT API 发送邀请
    ↓
【如果成功】
      更新兑换码状态为已使用
      记录使用记录
      更新 Team 的 current_members +1
      【提交事务】
    ↓
【如果失败】
      【回滚事务】
      返回错误信息
```

### 4.3 Team 选择策略
- **用户主动选择**：展示可用 Team 列表，用户自主选择
- **随机分配**：优先选择成员数最少的 Team
- **容量检查**：只显示成员数 < 6 且未过期的 Team
- **失败处理**：如果所有 Team 已满或已过期，返回错误提示

---

## 5. 系统路由设计

### 5.1 管理员页面路由（需要认证）
- `GET /admin` - 管理员面板首页
- `GET /admin/teams/import` - Team 导入页面
- `POST /admin/teams/import` - 处理 Team 导入
- `POST /admin/teams/{id}/switch` - 切换 Team account-id
- `POST /admin/teams/{id}/delete` - 删除 Team
- `GET /admin/teams/{id}/members` - 成员管理页面
- `POST /admin/teams/{id}/members/add` - 添加成员
- `POST /admin/teams/{id}/members/{user_id}/delete` - 删除成员
- `GET /admin/codes` - 兑换码管理页面
- `POST /admin/codes/generate` - 生成兑换码
- `GET /admin/records` - 使用记录页面
- `GET /admin/settings` - 系统设置页面
- `POST /admin/settings/update` - 更新系统设置

### 5.2 用户页面路由
- `GET /` - 用户兑换页面
- `POST /redeem/verify` - 验证兑换码并展示可用 Team
- `POST /redeem/confirm` - 确认加入 Team

### 5.3 API 端点
- `GET /api/teams/{id}/refresh` - 刷新 Team 成员数
- `GET /api/teams/available` - 获取可用 Team 列表（JSON）

---

## 6. 开发优先级

### P0 - 核心功能
1. 配置管理（含代理配置）
2. Team 账号导入和存储
3. 兑换码生成和验证
4. 用户兑换流程
5. ChatGPT API 集成（发送邀请，支持代理）

### P1 - 重要功能
1. 管理员面板 UI
2. 用户页面 UI
3. Team 成员数和订阅信息同步
4. 成员管理（查看、添加、删除）
5. 使用记录查询
6. 系统设置页面

### P2 - 增强功能
1. 兑换码批量导出
2. 统计分析
3. 邮件通知
4. 高级筛选和搜索
5. 订阅到期提醒

---

## 7. 项目结构

```
team-manage/
├── app/
│   ├── main.py              # FastAPI 入口
│   ├── config.py            # 配置文件
│   ├── database.py          # 数据库连接
│   ├── models.py            # SQLAlchemy 模型
│   ├── routes/
│   │   ├── admin.py         # 管理员路由
│   │   ├── user.py          # 用户路由
│   │   ├── api.py           # API 端点
│   │   └── auth.py          # 认证路由
│   ├── services/
│   │   ├── chatgpt.py       # ChatGPT API 调用
│   │   ├── team.py          # Team 管理逻辑
│   │   ├── redemption.py    # 兑换码逻辑
│   │   └── encryption.py    # 加密服务
│   ├── utils/
│   │   ├── token_parser.py  # Token 解析
│   │   ├── jwt_parser.py    # JWT 解析
│   │   └── validators.py    # 输入验证
│   ├── templates/           # Jinja2 模板
│   └── static/              # 静态文件
├── requirements.txt
├── .env.example
└── README.md
```