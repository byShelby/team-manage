{% extends "base.html" %}

{% block title %}生成兑换码 - GPT Team 管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <h2>生成兑换码</h2>
</div>

<div class="content-section">
    <!-- 单个生成 -->
    <div class="card">
        <div class="card-header">
            <h3>单个生成</h3>
        </div>
        <div class="card-body">
            <form id="singleGenerateForm" onsubmit="generateSingle(event)">
                <div class="form-group">
                    <label for="customCode">自定义兑换码 (可选)</label>
                    <input
                        type="text"
                        id="customCode"
                        name="customCode"
                        class="form-control"
                        placeholder="留空则自动生成"
                        maxlength="32"
                    >
                    <small class="form-text">留空则自动生成格式为 XXXX-XXXX-XXXX-XXXX 的兑换码</small>
                </div>

                <div class="form-group">
                    <label for="singleExpiresDays">有效期 (天数, 可选)</label>
                    <input
                        type="number"
                        id="singleExpiresDays"
                        name="expiresDays"
                        class="form-control"
                        placeholder="留空则永久有效"
                        min="1"
                        max="3650"
                    >
                    <small class="form-text">留空则永久有效,最长3650天(10年)</small>
                </div>

                <button type="submit" class="btn btn-primary">生成兑换码</button>
            </form>

            <!-- 单个生成结果 -->
            <div id="singleResult" class="result-box" style="display: none;">
                <h4>生成成功</h4>
                <div class="code-display">
                    <code id="generatedCode"></code>
                    <button onclick="copyCode()" class="btn btn-sm btn-secondary">复制</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量生成 -->
    <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
            <h3>批量生成</h3>
        </div>
        <div class="card-body">
            <form id="batchGenerateForm" onsubmit="generateBatch(event)">
                <div class="form-group">
                    <label for="batchCount">生成数量 *</label>
                    <input
                        type="number"
                        id="batchCount"
                        name="count"
                        class="form-control"
                        placeholder="请输入生成数量"
                        min="1"
                        max="1000"
                        required
                    >
                    <small class="form-text">最少1个,最多1000个</small>
                </div>

                <div class="form-group">
                    <label for="batchExpiresDays">有效期 (天数, 可选)</label>
                    <input
                        type="number"
                        id="batchExpiresDays"
                        name="expiresDays"
                        class="form-control"
                        placeholder="留空则永久有效"
                        min="1"
                        max="3650"
                    >
                    <small class="form-text">留空则永久有效,最长3650天(10年)</small>
                </div>

                <button type="submit" class="btn btn-primary">批量生成</button>
            </form>

            <!-- 批量生成结果 -->
            <div id="batchResult" class="result-box" style="display: none;">
                <h4>批量生成成功</h4>
                <p>成功生成 <strong id="batchTotal">0</strong> 个兑换码</p>
                <div class="code-list">
                    <textarea id="batchCodes" readonly rows="10" class="form-control"></textarea>
                </div>
                <div style="margin-top: 1rem;">
                    <button onclick="copyBatchCodes()" class="btn btn-secondary">复制全部</button>
                    <button onclick="downloadCodes()" class="btn btn-secondary">下载为文件</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 单个生成
async function generateSingle(event) {
    event.preventDefault();

    const form = event.target;
    const customCode = form.customCode.value.trim();
    const expiresDays = form.expiresDays.value;

    // 构建请求数据
    const data = {
        type: 'single'
    };

    if (customCode) {
        data.code = customCode;
    }

    if (expiresDays) {
        data.expires_days = parseInt(expiresDays);
    }

    try {
        const response = await fetch('/admin/codes/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.success) {
            // 显示结果
            document.getElementById('generatedCode').textContent = result.code;
            document.getElementById('singleResult').style.display = 'block';

            // 清空表单
            form.reset();

            showToast('兑换码生成成功', 'success');
        } else {
            showToast(result.error || '生成失败', 'error');
        }
    } catch (error) {
        showToast('网络错误', 'error');
    }
}

// 批量生成
async function generateBatch(event) {
    event.preventDefault();

    const form = event.target;
    const count = parseInt(form.count.value);
    const expiresDays = form.expiresDays.value;

    if (count < 1 || count > 1000) {
        showToast('生成数量必须在1-1000之间', 'error');
        return;
    }

    // 构建请求数据
    const data = {
        type: 'batch',
        count: count
    };

    if (expiresDays) {
        data.expires_days = parseInt(expiresDays);
    }

    try {
        const response = await fetch('/admin/codes/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.success) {
            // 显示结果
            document.getElementById('batchTotal').textContent = result.total;
            document.getElementById('batchCodes').value = result.codes.join('\n');
            document.getElementById('batchResult').style.display = 'block';

            // 清空表单
            form.reset();

            showToast(`成功生成 ${result.total} 个兑换码`, 'success');
        } else {
            showToast(result.error || '生成失败', 'error');
        }
    } catch (error) {
        showToast('网络错误', 'error');
    }
}

// 复制单个兑换码
function copyCode() {
    const code = document.getElementById('generatedCode').textContent;
    navigator.clipboard.writeText(code).then(() => {
        showToast('已复制到剪贴板', 'success');
    }).catch(() => {
        showToast('复制失败', 'error');
    });
}

// 复制批量兑换码
function copyBatchCodes() {
    const codes = document.getElementById('batchCodes').value;
    navigator.clipboard.writeText(codes).then(() => {
        showToast('已复制到剪贴板', 'success');
    }).catch(() => {
        showToast('复制失败', 'error');
    });
}

// 下载兑换码文件
function downloadCodes() {
    const codes = document.getElementById('batchCodes').value;
    const blob = new Blob([codes], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `redemption_codes_${new Date().getTime()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('下载成功', 'success');
}
</script>
{% endblock %}
