{% extends "base.html" %}

{% block title %}系统设置 - GPT Team 管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <h2>系统设置</h2>
</div>

<!-- 代理配置 -->
<div class="content-section">
    <div class="section-header">
        <h3>代理配置</h3>
    </div>

    <form id="proxyForm" class="settings-form">
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="proxyEnabled" name="enabled" {% if proxy_enabled %}checked{% endif %}>
                <span>启用代理</span>
            </label>
            <p class="form-help">启用后,所有ChatGPT API请求将通过代理服务器</p>
        </div>

        <div class="form-group">
            <label for="proxyUrl">代理地址</label>
            <input
                type="text"
                id="proxyUrl"
                name="proxy"
                value="{{ proxy or '' }}"
                placeholder="http://127.0.0.1:7890 或 socks5://127.0.0.1:1080"
                class="form-control"
            >
            <p class="form-help">支持HTTP和SOCKS5代理,格式: http://host:port 或 socks5://host:port</p>
        </div>

        <button type="submit" class="btn btn-primary">保存代理配置</button>
    </form>
</div>

<!-- 密码修改 -->
<div class="content-section">
    <div class="section-header">
        <h3>修改密码</h3>
    </div>

    <form id="passwordForm" class="settings-form">
        <div class="form-group">
            <label for="oldPassword">旧密码</label>
            <input
                type="password"
                id="oldPassword"
                name="old_password"
                required
                class="form-control"
                placeholder="请输入当前密码"
            >
        </div>

        <div class="form-group">
            <label for="newPassword">新密码</label>
            <input
                type="password"
                id="newPassword"
                name="new_password"
                required
                minlength="6"
                class="form-control"
                placeholder="请输入新密码(至少6位)"
            >
        </div>

        <div class="form-group">
            <label for="confirmPassword">确认新密码</label>
            <input
                type="password"
                id="confirmPassword"
                name="confirm_password"
                required
                minlength="6"
                class="form-control"
                placeholder="请再次输入新密码"
            >
        </div>

        <button type="submit" class="btn btn-primary">修改密码</button>
        <p class="form-help">修改密码后需要重新登录</p>
    </form>
</div>

<!-- 日志级别 -->
<div class="content-section">
    <div class="section-header">
        <h3>日志级别</h3>
    </div>

    <form id="logLevelForm" class="settings-form">
        <div class="form-group">
            <label for="logLevel">日志级别</label>
            <select id="logLevel" name="level" class="form-control">
                <option value="DEBUG" {% if log_level == 'DEBUG' %}selected{% endif %}>DEBUG - 调试信息</option>
                <option value="INFO" {% if log_level == 'INFO' %}selected{% endif %}>INFO - 一般信息</option>
                <option value="WARNING" {% if log_level == 'WARNING' %}selected{% endif %}>WARNING - 警告信息</option>
                <option value="ERROR" {% if log_level == 'ERROR' %}selected{% endif %}>ERROR - 错误信息</option>
                <option value="CRITICAL" {% if log_level == 'CRITICAL' %}selected{% endif %}>CRITICAL - 严重错误</option>
            </select>
            <p class="form-help">调整系统日志的详细程度,DEBUG级别会记录最详细的信息</p>
        </div>

        <button type="submit" class="btn btn-primary">保存日志级别</button>
    </form>
</div>
{% endblock %}

{% block extra_css %}
<style>
.settings-form {
    background-color: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: var(--shadow);
    max-width: 600px;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}

.form-control {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.9rem;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
}

.form-help {
    font-size: 0.85rem;
    color: var(--secondary-color);
    margin-top: 0.5rem;
    margin-bottom: 0;
}

.checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-weight: normal;
}

.checkbox-label input[type="checkbox"] {
    margin-right: 0.5rem;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.checkbox-label span {
    font-size: 0.95rem;
}

.content-section {
    margin-bottom: 2rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 代理配置表单
document.getElementById('proxyForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const enabled = document.getElementById('proxyEnabled').checked;
    const proxy = document.getElementById('proxyUrl').value.trim();

    // 验证
    if (enabled && !proxy) {
        showToast('请输入代理地址', 'error');
        return;
    }

    try {
        const response = await fetch('/admin/settings/proxy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ enabled, proxy })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            showToast('代理配置已保存', 'success');
        } else {
            showToast(data.error || '保存失败', 'error');
        }
    } catch (error) {
        showToast('网络错误', 'error');
    }
});

// 密码修改表单
document.getElementById('passwordForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // 验证
    if (newPassword.length < 6) {
        showToast('新密码至少6位', 'error');
        return;
    }

    if (newPassword !== confirmPassword) {
        showToast('两次输入的密码不一致', 'error');
        return;
    }

    try {
        const response = await fetch('/auth/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                old_password: oldPassword,
                new_password: newPassword
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            showToast('密码修改成功,即将跳转到登录页', 'success');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            showToast(data.error || '修改失败', 'error');
        }
    } catch (error) {
        showToast('网络错误', 'error');
    }
});

// 日志级别表单
document.getElementById('logLevelForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const level = document.getElementById('logLevel').value;

    try {
        const response = await fetch('/admin/settings/log-level', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ level })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            showToast('日志级别已保存', 'success');
        } else {
            showToast(data.error || '保存失败', 'error');
        }
    } catch (error) {
        showToast('网络错误', 'error');
    }
});
</script>
{% endblock %}
