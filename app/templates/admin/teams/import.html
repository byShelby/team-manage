{% extends "base.html" %}

{% block title %}导入 Team - GPT Team 管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <h2>导入 Team</h2>
</div>

<!-- 导入方式选择 -->
<div class="content-section">
    <div class="import-tabs">
        <button class="tab-button active" onclick="switchTab('single')">单个导入</button>
        <button class="tab-button" onclick="switchTab('batch')">批量导入</button>
    </div>

    <!-- 单个导入表单 -->
    <div id="singleImport" class="import-panel">
        <form id="singleImportForm" onsubmit="handleSingleImport(event)">
            <div class="form-group">
                <label for="accessToken">Access Token (AT) <span class="required">*</span></label>
                <textarea
                    id="accessToken"
                    name="accessToken"
                    class="form-control"
                    rows="4"
                    placeholder="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ik1UaEVOVUpHTkVNMVFURTRNMEZCTWpkQ05UZzVNRFUxUlRVd1FVSkRNRU13UmtGRVFrRXpSZyJ9..."
                    required
                ></textarea>
                <small class="form-text">必填项，以 eyJ 开头的 JWT Token</small>
            </div>

            <div class="form-group">
                <label for="email">邮箱</label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    class="form-control"
                    placeholder="admin@example.com"
                >
                <small class="form-text">可选，如果不填写将从 Token 中自动提取</small>
            </div>

            <div class="form-group">
                <label for="accountId">Account ID</label>
                <input
                    type="text"
                    id="accountId"
                    name="accountId"
                    class="form-control"
                    placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                >
                <small class="form-text">可选，如果不填写将从 API 自动获取</small>
            </div>

            <div id="singleErrorMessage" class="error-message" style="display: none;"></div>
            <div id="singleSuccessMessage" class="success-message" style="display: none;"></div>

            <button type="submit" class="btn btn-primary">导入</button>
            <a href="/admin" class="btn btn-secondary">返回</a>
        </form>
    </div>

    <!-- 批量导入表单 -->
    <div id="batchImport" class="import-panel" style="display: none;">
        <form id="batchImportForm" onsubmit="handleBatchImport(event)">
            <div class="form-group">
                <label for="batchContent">批量导入内容 <span class="required">*</span></label>
                <textarea
                    id="batchContent"
                    name="batchContent"
                    class="form-control"
                    rows="10"
                    placeholder="一行一个 AT Token，系统会自动识别邮箱和 Account ID

推荐格式：
eyJhbGc...
eyJhbGc...
eyJhbGc...

也支持带邮箱格式：
eyJhbGc... admin@example.com"
                    required
                ></textarea>
                <small class="form-text">每行一个 Team，系统会自动识别 AT Token 和邮箱。<strong>Account ID 会自动从 API 获取，无需手动提供。</strong></small>
            </div>

            <div class="format-help">
                <h4>格式说明</h4>
                <ul>
                    <li>每行一个 Team 信息</li>
                    <li>AT Token 必填（以 eyJ 开头）</li>
                    <li>邮箱和 Account ID 可选</li>
                    <li>支持任意分隔符（空格、逗号、制表符等）</li>
                    <li>系统会自动识别和提取信息</li>
                </ul>
            </div>

            <div id="batchErrorMessage" class="error-message" style="display: none;"></div>
            <div id="batchResultsContainer" style="display: none;">
                <h4>导入结果</h4>
                <div id="batchResults"></div>
            </div>

            <button type="submit" class="btn btn-primary">批量导入</button>
            <a href="/admin" class="btn btn-secondary">返回</a>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 切换导入方式
function switchTab(type) {
    const singlePanel = document.getElementById('singleImport');
    const batchPanel = document.getElementById('batchImport');
    const tabs = document.querySelectorAll('.tab-button');

    if (type === 'single') {
        singlePanel.style.display = 'block';
        batchPanel.style.display = 'none';
        tabs[0].classList.add('active');
        tabs[1].classList.remove('active');
    } else {
        singlePanel.style.display = 'none';
        batchPanel.style.display = 'block';
        tabs[0].classList.remove('active');
        tabs[1].classList.add('active');
    }
}

// 处理单个导入
async function handleSingleImport(event) {
    event.preventDefault();

    const accessToken = document.getElementById('accessToken').value.trim();
    const email = document.getElementById('email').value.trim();
    const accountId = document.getElementById('accountId').value.trim();
    const errorMessage = document.getElementById('singleErrorMessage');
    const successMessage = document.getElementById('singleSuccessMessage');
    const submitButton = event.target.querySelector('button[type="submit"]');

    // 隐藏之前的消息
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';

    // 禁用提交按钮
    submitButton.disabled = true;
    submitButton.textContent = '导入中...';

    try {
        const response = await fetch('/admin/teams/import', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                import_type: 'single',
                access_token: accessToken,
                email: email || null,
                account_id: accountId || null
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            successMessage.textContent = data.message || 'Team 导入成功！';
            successMessage.style.display = 'block';
            // 清空表单
            document.getElementById('singleImportForm').reset();
            // 3秒后跳转到首页
            setTimeout(() => {
                window.location.href = '/admin';
            }, 2000);
        } else {
            errorMessage.textContent = data.error || '导入失败';
            errorMessage.style.display = 'block';
        }
    } catch (error) {
        errorMessage.textContent = '网络错误，请稍后重试';
        errorMessage.style.display = 'block';
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = '导入';
    }
}

// 处理批量导入
async function handleBatchImport(event) {
    event.preventDefault();

    const batchContent = document.getElementById('batchContent').value.trim();
    const errorMessage = document.getElementById('batchErrorMessage');
    const resultsContainer = document.getElementById('batchResultsContainer');
    const resultsDiv = document.getElementById('batchResults');
    const submitButton = event.target.querySelector('button[type="submit"]');

    // 隐藏之前的消息
    errorMessage.style.display = 'none';
    resultsContainer.style.display = 'none';

    // 禁用提交按钮
    submitButton.disabled = true;
    submitButton.textContent = '导入中...';

    try {
        const response = await fetch('/admin/teams/import', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                import_type: 'batch',
                content: batchContent
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // 显示导入结果
            let html = `<div class="batch-summary">
                <p>总数: ${data.total} | 成功: <span class="text-success">${data.success_count}</span> | 失败: <span class="text-danger">${data.failed_count}</span></p>
            </div>`;

            if (data.results && data.results.length > 0) {
                html += '<table class="data-table"><thead><tr><th>邮箱</th><th>Account ID</th><th>状态</th><th>消息</th></tr></thead><tbody>';
                data.results.forEach(result => {
                    const statusClass = result.success ? 'text-success' : 'text-danger';
                    const statusText = result.success ? '成功' : '失败';
                    const message = result.success ? result.message : result.error;
                    html += `<tr>
                        <td>${result.email}</td>
                        <td>${result.account_id || '-'}</td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>${message}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }

            resultsDiv.innerHTML = html;
            resultsContainer.style.display = 'block';

            // 如果全部成功，3秒后跳转
            if (data.failed_count === 0) {
                setTimeout(() => {
                    window.location.href = '/admin';
                }, 3000);
            }
        } else {
            errorMessage.textContent = data.error || '批量导入失败';
            errorMessage.style.display = 'block';
        }
    } catch (error) {
        errorMessage.textContent = '网络错误，请稍后重试';
        errorMessage.style.display = 'block';
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = '批量导入';
    }
}
</script>
{% endblock %}
