{% extends "base.html" %}

{% block title %}成员管理 - GPT Team 管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Team 成员管理</h2>
</div>

<!-- Team 信息 -->
<div class="content-section">
    <h3>Team 信息</h3>
    <div class="team-info-grid">
        <div class="info-item">
            <span class="info-label">邮箱:</span>
            <span class="info-value">{{ team.email }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Team 名称:</span>
            <span class="info-value">{{ team.team_name or '-' }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">成员数:</span>
            <span class="info-value">{{ team.current_members }}/{{ team.max_members }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">订阅计划:</span>
            <span class="info-value">{{ team.subscription_plan or '-' }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">到期时间:</span>
            <span class="info-value">{{ team.expires_at|format_datetime }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">状态:</span>
            <span class="status-badge status-{{ team.status }}">
                {% if team.status == 'active' %}
                    可用
                {% elif team.status == 'full' %}
                    已满
                {% elif team.status == 'expired' %}
                    已过期
                {% else %}
                    异常
                {% endif %}
            </span>
        </div>
    </div>
</div>

<!-- 添加成员 -->
<div class="content-section">
    <h3>添加成员</h3>
    <form id="addMemberForm" onsubmit="handleAddMember(event)">
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label for="memberEmail">成员邮箱 <span class="required">*</span></label>
                <input
                    type="email"
                    id="memberEmail"
                    name="memberEmail"
                    class="form-control"
                    placeholder="user@example.com"
                    required
                >
            </div>
            <div class="form-group" style="align-self: flex-end;">
                <button type="submit" class="btn btn-primary">添加成员</button>
            </div>
        </div>
        <div id="addMemberError" class="error-message" style="display: none;"></div>
        <div id="addMemberSuccess" class="success-message" style="display: none;"></div>
    </form>
</div>

<!-- 成员列表 -->
<div class="content-section">
    <div class="section-header">
        <h3>成员列表 ({{ members|length }})</h3>
        <button onclick="refreshMembers()" class="btn btn-secondary">刷新</button>
    </div>

    {% if members %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>邮箱</th>
                    <th>名称</th>
                    <th>角色</th>
                    <th>加入时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for member in members %}
                <tr>
                    <td>{{ member.email }}</td>
                    <td>{{ member.name or '-' }}</td>
                    <td>
                        <span class="role-badge role-{{ member.role }}">
                            {% if member.role == 'account-owner' %}
                                所有者
                            {% else %}
                                成员
                            {% endif %}
                        </span>
                    </td>
                    <td>{{ member.added_at|format_datetime }}</td>
                    <td>
                        {% if member.role != 'account-owner' %}
                        <button
                            onclick="deleteMember('{{ member.user_id }}', '{{ member.email }}')"
                            class="btn btn-sm btn-danger"
                        >
                            删除
                        </button>
                        {% else %}
                        <span class="text-muted">不可删除</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>暂无成员数据</p>
    </div>
    {% endif %}
</div>

<div style="margin-top: 2rem;">
    <a href="/admin" class="btn btn-secondary">返回控制台</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
const teamId = {{ team.id }};

// 添加成员
async function handleAddMember(event) {
    event.preventDefault();

    const email = document.getElementById('memberEmail').value.trim();
    const errorDiv = document.getElementById('addMemberError');
    const successDiv = document.getElementById('addMemberSuccess');
    const submitButton = event.target.querySelector('button[type="submit"]');

    // 隐藏之前的消息
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';

    // 禁用提交按钮
    submitButton.disabled = true;
    submitButton.textContent = '添加中...';

    try {
        const response = await fetch(`/admin/teams/${teamId}/members/add`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            successDiv.textContent = data.message || '成员添加成功！';
            successDiv.style.display = 'block';
            // 清空表单
            document.getElementById('addMemberForm').reset();
            // 1秒后刷新页面
            setTimeout(() => location.reload(), 1000);
        } else {
            errorDiv.textContent = data.error || '添加失败';
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        errorDiv.textContent = '网络错误，请稍后重试';
        errorDiv.style.display = 'block';
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = '添加成员';
    }
}

// 删除成员
async function deleteMember(userId, email) {
    if (!confirm(`确定要删除成员 "${email}" 吗?\n\n此操作不可恢复!`)) {
        return;
    }

    try {
        showToast('正在删除...', 'info');
        const response = await fetch(`/admin/teams/${teamId}/members/${userId}/delete`, {
            method: 'POST'
        });

        const data = await response.json();

        if (response.ok && data.success) {
            showToast('删除成功', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || '删除失败', 'error');
        }
    } catch (error) {
        showToast('网络错误', 'error');
    }
}

// 刷新成员列表
function refreshMembers() {
    location.reload();
}
</script>
{% endblock %}
